/**
 * Leaderboard Command
 * 
 * Handles the /leaderboard slash command for viewing quiz performance and statistics
 */

const { SlashCommandBuilder, EmbedBuilder } = require('discord.js');
const { getLeaderboard, getUserStats } = require('../../services/storage');

/**
 * Handle the /leaderboard command
 * @param {Object} interaction - Discord interaction object
 */
async function handleLeaderboardCommand(interaction) {
  try {
    // First acknowledge the interaction to prevent timeouts
    await interaction.deferReply();
    
    // Determine which subcommand was used
    const subcommand = interaction.options.getSubcommand();
    
    if (subcommand === 'global') {
      await handleGlobalLeaderboard(interaction);
    } else if (subcommand === 'me') {
      await handlePersonalStats(interaction);
    }
  } catch (error) {
    console.error('Error in leaderboard command:', error);
    // Try to send an error message
    try {
      if (interaction.deferred || interaction.replied) {
        await interaction.editReply('An error occurred while retrieving leaderboard data.');
      } else {
        await interaction.reply({ content: 'An error occurred while retrieving leaderboard data.', ephemeral: true });
      }
    } catch (replyError) {
      console.error('Failed to send error message:', replyError);
    }
  }
}

/**
 * Handle the global leaderboard subcommand
 * @param {Object} interaction - Discord interaction
 */
async function handleGlobalLeaderboard(interaction) {
  // Get sort option from command
  const sortBy = interaction.options.getString('sort') || 'correctAnswers';
  
  // Get leaderboard data
  const leaderboardData = await getLeaderboard({ orderBy: sortBy, limit: 10 });
  
  if (!leaderboardData || leaderboardData.length === 0) {
    await interaction.editReply('No quiz data found yet. Be the first to take a quiz!');
    return;
  }
  
  // Create embed for leaderboard
  const embed = new EmbedBuilder()
    .setTitle('ðŸ† Quiz Leaderboard')
    .setDescription(`Top performers sorted by ${sortBy === 'correctAnswers' ? 'correct answers' : 
                                              sortBy === 'accuracy' ? 'accuracy' : 
                                              sortBy === 'totalAnswered' ? 'total questions answered' : 
                                              'quizzes taken'}`)
    .setColor('#00AAFF')
    .setTimestamp();
  
  // Add each user to the leaderboard
  leaderboardData.forEach((entry, index) => {
    const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : `${index + 1}.`;
    
    embed.addFields({
      name: `${medal} <@${entry.userDiscordId}>`,
      value: `**Score:** ${sortBy === 'correctAnswers' ? entry.correctAnswers : 
                        sortBy === 'accuracy' ? `${Math.round(entry.accuracy * 100) / 100}%` : 
                        sortBy === 'totalAnswered' ? entry.totalAnswered : 
                        entry.quizzesTaken}
**Correct/Total:** ${entry.correctAnswers || 0}/${entry.totalAnswered || 0}
**Accuracy:** ${Math.round((entry.accuracy || 0) * 100) / 100}%`,
      inline: true
    });
    
    // Add a blank field for better formatting (2 columns)
    if (index % 2 === 0 && index < leaderboardData.length - 1) {
      embed.addFields({ name: '\u200B', value: '\u200B', inline: true });
    }
  });
  
  embed.setFooter({ text: 'Use /leaderboard me to see your personal stats' });
  
  await interaction.editReply({ embeds: [embed] });
}



/**
 * Handle the personal stats subcommand
 * @param {Object} interaction - Discord interaction
 */
async function handlePersonalStats(interaction) {
  // Get user stats
  const userStats = await getUserStats(interaction.user.id);
  
  const embed = new EmbedBuilder()
    .setTitle('ðŸ“Š Your Quiz Statistics')
    .setColor('#00AAFF')
    .setTimestamp()
    .setFooter({ text: 'Keep answering quizzes to improve your stats!' });

  if (!userStats) {
    embed.setDescription('No quiz activity yet. Try answering some quizzes first!');
  } else {
    // Get user rank
    const rank = await getRank(interaction.user.id, userStats.correctAnswers);
    
    // Set description with stats
    embed.setDescription(`**Rank:** ${rank}\n\n${formatUserStats(userStats)}`);
  }
  
  await interaction.editReply({ embeds: [embed] });
}

/**
 * Format user stats for display
 * @param {Object} stats - User statistics
 * @returns {string} - Formatted stats text
 */
function formatUserStats(stats) {
  if (!stats) {
    return 'No quiz activity yet.';
  }
  
  return `**Total Questions:** ${stats.totalAnswered || 0}
**Correct Answers:** ${stats.correctAnswers || 0}
**Accuracy:** ${Math.round((stats.accuracy || 0) * 100) / 100}%
**Quizzes Taken:** ${stats.quizzesTaken || 0}`;
}

/**
 * Get user rank based on correct answers
 * @param {string} userDiscordId - Discord user ID
 * @param {number} userCorrectAnswers - Number of correct answers
 * @returns {string} - Rank description
 */
async function getRank(userDiscordId, userCorrectAnswers) {
  if (!userCorrectAnswers) return 'Unranked';
  
  try {
    // Get all users sorted by correct answers
    const allUsers = await getLeaderboard({ orderBy: 'correctAnswers', limit: 100 });
    
    // Find user's position
    const userPosition = allUsers.findIndex(user => user.userDiscordId === userDiscordId);
    
    if (userPosition === -1) return 'Unranked';
    
    // Return position (1-indexed)
    const position = userPosition + 1;
    
    // Add medal if in top 3
    if (position === 1) return 'ðŸ¥‡ 1st Place';
    if (position === 2) return 'ðŸ¥ˆ 2nd Place';
    if (position === 3) return 'ðŸ¥‰ 3rd Place';
    
    // Otherwise return position with appropriate suffix
    const suffixes = ['th', 'st', 'nd', 'rd'];
    const suffix = position % 100 <= 10 || position % 100 >= 14 ? 
                  suffixes[position % 10 < 4 ? position % 10 : 0] : 
                  suffixes[0];
    
    return `${position}${suffix} Place`;
  } catch (error) {
    console.error('Error getting user rank:', error);
    return 'Rank Unavailable';
  }
}

module.exports = {
  data: new SlashCommandBuilder()
    .setName('leaderboard')
    .setDescription('View quiz leaderboard and statistics')
    .addSubcommand(subcommand =>
      subcommand
        .setName('global')
        .setDescription('View the global leaderboard')
        .addStringOption(option =>
          option
            .setName('sort')
            .setDescription('How to sort the leaderboard')
            .setRequired(false)
            .addChoices(
              { name: 'Correct Answers', value: 'correctAnswers' },
              { name: 'Accuracy', value: 'accuracy' },
              { name: 'Total Answered', value: 'totalAnswered' },
              { name: 'Quizzes Taken', value: 'quizzesTaken' }
            )
        )
    )
    .addSubcommand(subcommand =>
      subcommand
        .setName('me')
        .setDescription('View your personal quiz statistics')
    ),
  execute: handleLeaderboardCommand
};

// Also export helper functions if needed for testing
module.exports.handleLeaderboardCommand = handleLeaderboardCommand;
module.exports.handleGlobalLeaderboard = handleGlobalLeaderboard;
module.exports.handlePersonalStats = handlePersonalStats;
module.exports.formatUserStats = formatUserStats;
module.exports.getRank = getRank;
